"use strict";(()=>{var e={};e.id=265,e.ids=[265],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9766:(e,r,t)=>{t.r(r),t.d(r,{config:()=>u,default:()=>o,routeModule:()=>l});var a={};t.r(a),t.d(a,{default:()=>handler});var s=t(1802),i=t(7153),n=t(6249),d=t(6962);async function handler(e,r){if("GET"===e.method){let{listId:t,itemId:a}=e.query;if(!t&&!a)return r.status(400).json({error:"missing_target"});let s=d.R.from("comments").select("*").order("created_at",{ascending:!0}),{data:i,error:n}=t?await s.eq("list_id",t):await s.eq("item_id",a);if(n)return r.status(500).json({error:"db_error"});let o=Array.from(new Set((i||[]).map(e=>e.user_id).filter(Boolean))),u={};for(let e of o)try{let{data:r}=await d.R.auth.admin.getUserById(e);r?.user&&(u[e]=(r.user.email||"").split("@")[0])}catch{}let l={};(i||[]).forEach(e=>l[e.id]={...e,user_email:u[e.user_id]});let _=[];return(i||[]).forEach(e=>{e.parent_id?l[e.parent_id]?.children?l[e.parent_id].children.push(l[e.id]):l[e.parent_id].children=[l[e.id]]:_.push(l[e.id])}),r.json(_)}if("POST"===e.method){let t=e.headers.authorization;if(!t||!t.startsWith("Bearer "))return r.status(401).json({error:"not_authenticated"});let a=t.split(" ")[1],{data:s}=await d.R.auth.getUser(a),i=s?.user;if(!i)return r.status(401).json({error:"invalid_token"});let{listId:n,itemId:o,content:u,parentId:l}=e.body;if(!u||!n&&!o)return r.status(400).json({error:"missing_fields"});let{error:_}=await d.R.from("comments").insert([{user_id:i.id,list_id:n||null,item_id:o||null,parent_id:l||null,content:u}]);return _?r.status(500).json({error:"db_error"}):r.json({ok:!0})}return r.status(405).end()}let o=(0,n.l)(a,"default"),u=(0,n.l)(a,"config"),l=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/comments",pathname:"/api/comments",bundlePath:"",filename:""},userland:a})},6962:(e,r,t)=>{t.d(r,{R:()=>i});let a=require("@supabase/supabase-js"),s=process.env.SUPABASE_SERVICE_ROLE_KEY,i=(0,a.createClient)("https://pgsvorcullkrgmcbpszb.supabase.co",s,{auth:{persistSession:!1}})}};var r=require("../../webpack-api-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[222],()=>__webpack_exec__(9766));module.exports=t})();