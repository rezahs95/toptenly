"use strict";(()=>{var e={};e.id=198,e.ids=[198],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2079:e=>{e.exports=import("openai")},9537:(e,t,a)=>{a.a(e,async(e,i)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>o,routeModule:()=>u});var s=a(1802),r=a(7153),l=a(6249),n=a(9352),c=e([n]);n=(c.then?(await c)():c)[0];let o=(0,l.l)(n,"default"),d=(0,l.l)(n,"config"),u=new s.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/search",pathname:"/api/search",bundlePath:"",filename:""},userland:n});i()}catch(e){i(e)}})},6357:(e,t,a)=>{a.a(e,async(e,i)=>{try{a.d(t,{f:()=>l});var s=a(2079),r=e([s]);s=(r.then?(await r)():r)[0];let l=new s.default({apiKey:process.env.OPENAI_API_KEY});i()}catch(e){i(e)}})},6962:(e,t,a)=>{a.d(t,{R:()=>r});let i=require("@supabase/supabase-js"),s=process.env.SUPABASE_SERVICE_ROLE_KEY,r=(0,i.createClient)("https://pgsvorcullkrgmcbpszb.supabase.co",s,{auth:{persistSession:!1}})},9352:(e,t,a)=>{a.a(e,async(e,i)=>{try{a.r(t),a.d(t,{default:()=>handler});var s=a(6962),r=a(6357),l=e([r]);function slugify(e){return e.toLowerCase().replace(/[^a-z0-9\u0600-\u06FF]+/g,"-").replace(/(^-|-$)/g,"")}async function handler(e,t){if("POST"!==e.method)return t.status(405).end();let{query:a}=e.body;if(!a)return t.status(400).json({error:"no query"});try{await s.R.rpc("increment_search",{p_query:a})}catch{}let i=slugify(a),{data:l}=await s.R.from("lists").select("*").eq("slug",i).limit(1);if(l&&l.length>0){let e=l[0],{data:a}=await s.R.from("list_items").select("id,title,description").eq("list_id",e.id),{data:i}=await s.R.rpc("aggregate_scores",{p_list_id:e.id}),r={};(i||[]).forEach(e=>r[e.item_id]=e.total);let n=(a||[]).map(e=>({...e,score:r[e.id]||0}));return t.json({list:{...e,items:n,source:"db"}})}let n=`Create a ranked Top 10 list for: ${a}. Return strictly a JSON array of objects: [{"title":"...","description":"..."}, ...] with exactly 10 items.`,c=await r.f.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"user",content:n}],max_tokens:800,temperature:.7}),o=c.choices[0].message.content||"[]",d=null;try{d=JSON.parse(o)}catch{d=null}d||(d=fallbackParse(o));let{data:u}=await s.R.from("lists").insert([{title:a,slug:i,source:"ai"}]).select("*").single(),p=(d||[]).slice(0,10).map(e=>({list_id:u.id,title:e.title,description:e.description||null}));await s.R.from("list_items").insert(p);let{data:m}=await s.R.from("list_items").select("*").eq("list_id",u.id),f=(m||[]).map(e=>({...e,score:0}));return t.json({list:{...u,items:f,source:"ai"}})}function fallbackParse(e){let t=e.split("\n").filter(Boolean),a=[];for(let e of t){let t=e.match(/\d+\.\s*(.*?)(?:\s*-\s*(.*))?$/);if(t&&a.push({title:t[1].trim(),description:t[2]?.trim()}),a.length>=10)break}for(;a.length<10;)a.push({title:`Item ${a.length+1}`,description:""});return a}r=(l.then?(await l)():l)[0],i()}catch(e){i(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[222],()=>__webpack_exec__(9537));module.exports=a})();