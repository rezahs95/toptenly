"use strict";(()=>{var e={};e.id=140,e.ids=[140],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},8140:(e,t,r)=>{r.r(t),r.d(t,{config:()=>l,default:()=>d,routeModule:()=>c});var s={};r.r(s),r.d(s,{default:()=>handler});var a=r(1802),i=r(7153),o=r(6249),n=r(6962);let u=process.env.RECAPTCHA_SECRET_KEY;async function handler(e,t){if("POST"!==e.method)return t.status(405).end();let{listId:r,itemId:s,weight:a,captchaToken:i}=e.body;if(!r||!s||!a)return t.status(400).json({error:"missing"});if(u){if(!i)return t.status(400).json({error:"captcha_required"});let e=new URLSearchParams({secret:u,response:String(i)}),r=await fetch("https://www.google.com/recaptcha/api/siteverify",{method:"POST",body:e}),s=await r.json();if(!s.success||void 0!==s.score&&s.score<.4)return t.status(403).json({error:"captcha_invalid"})}let o=e.headers.authorization;if(!o||!o.startsWith("Bearer "))return t.status(401).json({error:"not_authenticated"});let d=o.split(" ")[1],{data:l,error:c}=await n.R.auth.getUser(d);if(c||!l?.user)return t.status(401).json({error:"invalid_token"});let p=l.user.id,{data:_}=await n.R.from("votes").select("id").eq("user_id",p).eq("list_id",r);if((_||[]).length>=3)return t.status(403).json({error:"vote_limit_reached"});let{data:h}=await n.R.from("votes").select("id").eq("user_id",p).eq("item_id",s).eq("weight",a).limit(1);if(h&&h.length>0)return t.status(400).json({error:"duplicate_vote"});let{error:f}=await n.R.from("votes").insert([{user_id:p,list_id:r,item_id:s,weight:a}]);return f?t.status(500).json({error:"db_error"}):t.json({ok:!0})}let d=(0,o.l)(s,"default"),l=(0,o.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/vote",pathname:"/api/vote",bundlePath:"",filename:""},userland:s})},6962:(e,t,r)=>{r.d(t,{R:()=>i});let s=require("@supabase/supabase-js"),a=process.env.SUPABASE_SERVICE_ROLE_KEY,i=(0,s.createClient)("https://pgsvorcullkrgmcbpszb.supabase.co",a,{auth:{persistSession:!1}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[222],()=>__webpack_exec__(8140));module.exports=r})();